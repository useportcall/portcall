{{- if .Values.minio.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: minio-init
  namespace: {{ .Values.global.namespace }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "5"
    "helm.sh/hook-delete-policy": before-hook-creation
    "helm.sh/hook-timeout": "600s"
spec:
  template:
    metadata:
      labels:
        app: minio-init
    spec:
      restartPolicy: OnFailure
      initContainers:
      - name: wait-for-minio
        image: curlimages/curl:latest
        command:
        - sh
        - -c
        - |
          until curl -f http://minio:{{ .Values.minio.port }}/minio/health/live; do
            echo "Waiting for MinIO..."
            sleep 5
          done
          echo "MinIO is ready!"
      containers:
      - name: mc
        image: minio/mc:latest
        command:
        - sh
        - -c
        - |
          mc alias set portcall http://minio:{{ .Values.minio.port }} {{ .Values.minio.rootUser }} {{ .Values.minio.rootPassword }}
          {{- range .Values.minio.buckets }}
          mc mb -p portcall/{{ . }} || echo "Bucket {{ . }} already exists"
          {{- end }}
          echo "✅ MinIO buckets created successfully"
        env:
        - name: MC_HOST_portcall
          value: "http://{{ .Values.minio.rootUser }}:{{ .Values.minio.rootPassword }}@minio:{{ .Values.minio.port }}"
{{- end }}
---
{{- if and .Values.postgresql.enabled .Values.keycloak.enabled .Values.keycloak.database.createDatabase }}
apiVersion: batch/v1
kind: Job
metadata:
  name: keycloak-db-init
  namespace: {{ .Values.global.namespace }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "1"
    "helm.sh/hook-delete-policy": before-hook-creation
    "helm.sh/hook-timeout": "600s"
spec:
  template:
    metadata:
      labels:
        app: keycloak-db-init
    spec:
      restartPolicy: OnFailure
      initContainers:
      - name: wait-for-postgres
        image: postgres:16
        command:
        - sh
        - -c
        - |
          until pg_isready -h {{ .Values.postgresql.host }} -p {{ .Values.postgresql.port }} -U {{ .Values.postgresql.user }}; do
            echo "Waiting for postgres..."
            sleep 2
          done
      containers:
      - name: create-keycloak-db
        image: postgres:16
        command:
        - sh
        - -c
        - |
          PGPASSWORD={{ .Values.postgresql.password }} psql -h {{ .Values.postgresql.host }} -U {{ .Values.postgresql.user }} -d {{ .Values.postgresql.database }} -tc "SELECT 1 FROM pg_database WHERE datname = '{{ .Values.keycloak.database.name }}'" | grep -q 1 || \
          PGPASSWORD={{ .Values.postgresql.password }} psql -h {{ .Values.postgresql.host }} -U {{ .Values.postgresql.user }} -d {{ .Values.postgresql.database }} -c "CREATE DATABASE {{ .Values.keycloak.database.name }};"
          echo "✅ Keycloak database ready"
{{- end }}
